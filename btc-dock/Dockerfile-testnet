# bitcoin-local-box docker image - Testnet

#TODO # interactive version (btcnode:it)

# Debian
FROM debian:latest

RUN apt-get update
RUN apt-get install --yes net-tools dnsutils wget bc
# dnsutils  -> nslookup
# netcat    -> nc

ARG binuri=https://github.com/frz-dev/bitcoin-local/raw/0.12.0-local/bin

# Local ENV
#TODO accept both local or url
#ENV binuri=https://github.com/frz-dev/bitcoin-local/raw/0.12.0-local/bin
ENV btcdir=/btc
ENV datadir=data
ENV bindir=bin
ENV btcnet=testnet3

# set working directory
RUN mkdir $btcdir
WORKDIR $btcdir

#RUN wget $btclocalbinurl && tar -zxvf *.tar.gz && rm *.tar.gz
RUN mkdir $datadir
COPY ./$datadir/bitcoin.conf-testnet $datadir/bitcoin.conf

RUN mkdir $bindir
COPY ./$bindir $bindir
# && wget -O $bindir/bitcoind $binuri/bitcoind \
# && wget -O $bindir/bitcoin-cli $binuri/bitcoin-cli \
RUN chmod +x $bindir/bitcoind $bindir/bitcoin-cli

RUN ln -s /btc/$bindir/bitcoind /usr/local/bin/bitcoind
RUN ln -s /btc/$bindir/bitcoin-cli /usr/local/bin/bitcoin-cli

COPY ./btc-node-run.sh ./

ENV btccli="bitcoin-cli -datadir=$datadir"
RUN echo "alias btc-cli='$btccli'" >> ~/.bashrc \
 && echo "alias getpeers='$btccli getpeerinfo'" >> ~/.bashrc \
 && echo "alias getblockcount='$btccli getblockcount'" >> ~/.bashrc \
 && echo "alias getlog='cat $datadir/$btcnet/debug.log'" >> ~/.bashrc \
 && echo "alias getpeersaddr='getpeers | grep addr'" >> ~/.bashrc \
 && echo "alias btcstart='bitcoind -datadir=$datadir -onlynet=ipv4 -debug -logips -daemon'" >> ~/.bashrc \
 && echo "alias btcstop='$btccli stop'" >> ~/.bashrc

# Expose Bitcoin ports
EXPOSE 18333 18332

# First clear the DNS nameserver, imported at runtime by docker
# Then run bitcoin
ENTRYPOINT echo "nameserver 127.0.0.11" > /etc/resolv.conf && /bin/bash
#  && bitcoind -datadir=$datadir -logips
#  \
#  && /bin/bash -i -c "source btc-node-run.sh $btcdir $datadir $btcnet"
